from selenium import webdriver
from bs4 import BeautifulSoup
import time
import csv
import tkinter as tk
from tkinter import ttk, messagebox
import json

BASE_URL = 'https://www.carsales.com.au'
BASE_URL_TEMPLATE = f'{BASE_URL}/cars/{{make}}/{{model}}/{{badge}}-badge/{{state}}-state/?page='
YEAR_RANGE_URL_TEMPLATE = f'{BASE_URL}/cars/?q=(And.(C.Make.{{make}}._.(C.Model.{{model}}._.Badge.{{badge}}.))_.State.{{state}}._.Year.range({{min_year}}..{{max_year}}).)'

def manual_selection():
    global driver
    driver = webdriver.Chrome()
    driver.get(BASE_URL)
    messagebox.showinfo("Info",
                        "Please make your selection in the browser. Once done, come back to the GUI and hit 'Scrape Now'. Don't close the browser.")

def save_to_csv(data, filename):
    keys = data[0].keys()
    with open(filename, 'w', newline='', encoding='utf-8') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=keys)
        writer.writeheader()
        writer.writerows(data)

def start_scraping():
    if 'driver' not in globals() or not driver.service.process:
        messagebox.showerror("Error", "Please select the car details manually in the browser first.")
        return

    page_source = driver.page_source
    soup = BeautifulSoup(page_source, 'html.parser')
    car_listings = soup.find_all('div', class_='listing-item')
    car_data = []

    for listing in car_listings:
        car_info = {}
        car_info['NetworkID'] = listing.get('data-webm-networkid')
        car_info['Category'] = listing.get('data-webm-vehcategory')
        car_info['BodyStyle'] = listing.get('data-webm-bodystyle')
        car_info['Make'] = listing.get('data-webm-make')
        car_info['Model'] = listing.get('data-webm-model')
        car_info['State'] = listing.get('data-webm-state')
        car_info['Price'] = listing.get('data-webm-price')
        badge_tag = listing.find('span', class_='csn-badge-title')
        car_info['Badge'] = badge_tag.text.strip() if badge_tag else None
        car_name_tag = listing.find("a", class_="js-encode-search")
        if car_name_tag:
            car_info['Name'] = car_name_tag.text.strip()
            car_info['Link'] = car_name_tag['href']
        images = []
        for img in listing.select(".carousel-item img"):
            img_src = img.get('src') or img.get('data-src')
            if img_src:
                images.append(img_src)
        car_info['Images'] = images
        key_details = {}
        for li in listing.select(".key-details li"):
            label = li.get('data-type')
            if label:
                key_details[label] = li.text.strip()
        car_info['KeyDetails'] = key_details
        car_data.append(car_info)

    if price_filter_var.get() == 1:
        car_data = [car for car in car_data if car.get('Badge') in ['Well below market price', 'Below market price']]

    if car_data:
        save_to_csv(car_data, 'cars_data.csv')
        messagebox.showinfo("Success", "Data has been saved to cars_data.csv")
    else:
        messagebox.showerror("Error", "No data found. Please check your selections and try again.")
